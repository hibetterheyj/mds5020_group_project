# Subtask 1: Sentiment Analysis with Voting Classifier

This directory contains the implementation of a voting classifier for sentiment analysis in financial news. The system uses a combination of multiple machine learning models to predict sentiment (-1 for negative, 1 for positive) from news titles.

## Directory Structure

```
task1_voting/
├── app_voting.py                # Flask API server for sentiment prediction
├── train_voting_classifier.py   # Script to train the voting classifier
├── test_voting_app.py           # Test script for API endpoints
├── utils.py                     # Utility functions for preprocessing and feature creation
├── model/                       # Directory containing trained model files
│   ├── voting_classifier.pkl           # Trained voting classifier model
│   └── voting_classifier_results.json  # Model performance results
├── voting_server.log            # Server log file
└── readme.md                    # This documentation
```

## File Descriptions

### app_voting.py
Flask API application that exposes endpoints for sentiment analysis:
- **/predict_sentiment**: POST endpoint for predicting sentiment from news text
- **/health**: GET endpoint for checking server health
- **/info**: GET endpoint for retrieving model information

The server runs on port 5726 by default and loads the pre-trained model at startup.

### train_voting_classifier.py
Script to train the voting classifier using 5-fold cross-validation:
- Loads and prepares training data from Excel files
- Creates pipelines for 7 different base classifiers with optimal parameters
- Implements a VotingClassifier with hard voting
- Saves the trained model and performance results to the model directory

### test_voting_app.py
Comprehensive test script for verifying API functionality:
- Tests health check and model info endpoints
- Performs sentiment prediction on sample news titles
- Calculates accuracy against actual sentiment labels

### utils.py
Utility functions for text preprocessing and feature engineering:
- TextPreprocessorTransformer: Custom transformer for text cleaning and normalization
- create_sentiment_features: Generates handcrafted features from text data
- Helper functions for data loading and preparation

### model/voting_classifier.pkl
Serialized VotingClassifier model containing 7 base estimators:
- ExtraTreesClassifier (with and without handcrafted features)
- LogisticRegression (without handcrafted features)
- SGDClassifier (without handcrafted features)
- SVC_Sigmoid (without handcrafted features)
- MLPClassifier (with handcrafted features)
- SVC_Poly (with handcrafted features)

### model/voting_classifier_results.json
JSON file containing model performance metrics:
- Cross-validation scores
- Average F1 score
- Base estimator details
- Training configuration

### voting_server.log
Log file generated by the Flask application containing:
- Server startup/shutdown events
- Model loading status
- Prediction requests and results
- Error messages and exceptions

## Usage Instructions

### 1. Training the Model

```bash
# Navigate to the directory
cd /Users/heyujie/Documents/cuhksz-all-sync/code/mds5020_group_project/task2/Project2_update/test_archive/task1_voting

# Install dependencies (if needed)
pip install -r requirements.txt

# Run the training script
python train_voting_classifier.py
```

This will:
- Load training data from `../../../data/Subtask1-sentiment_analysis/training_news-sentiment.xlsx`
- Perform 5-fold cross-validation
- Train the final model on all data
- Save the model to `model/voting_classifier.pkl`
- Save results to `model/voting_classifier_results.json`

### 2. Running the API Server

```bash
# Start the Flask server
python app_voting.py
```

The server will:
- Load the pre-trained model
- Start listening on port 5726
- Accept requests at the defined endpoints

### 3. Testing the API

```bash
# Run the test script (server must be running first)
python test_voting_app.py
```

This will:
- Check server health
- Retrieve model information
- Test sentiment prediction on 10 sample news titles
- Display prediction results and accuracy

### 4. Using the API Directly

**Sentiment Prediction Endpoint:**
```bash
curl -X POST -H "Content-Type: application/json" -d '{"text": "Company X announces record profits for the quarter"}' http://localhost:5726/predict_sentiment
```

**Health Check Endpoint:**
```bash
curl http://localhost:5726/health
```

**Model Info Endpoint:**
```bash
curl http://localhost:5726/info
```

## Sentiment Prediction

The model predicts sentiment values as follows:
- **-1**: Negative sentiment
- **1**: Positive sentiment

The voting classifier uses hard voting (majority decision) among its base estimators.

## Performance

The model was evaluated using 5-fold cross-validation with weighted F1 score as the primary metric. Detailed results are available in `model/voting_classifier_results.json`.

## Requirements

- Python 3.x
- Flask
- Pandas
- NumPy
- Scikit-learn
- Joblib
- Requests (for testing)